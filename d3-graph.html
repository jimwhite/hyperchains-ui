<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypernodes API Visualization</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        svg {
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <h1>Hypernodes API Visualization</h1>
    <div id="hc-graphs"></div>
    <svg id="force-directed-layout" width="800" height="600"></svg>
    <script>
        const apiBaseURL = "https://hypernodesapiprealpha.azurewebsites.net"; // Replace with your API base URL

        async function fetchNodeData(func) {
            const response = await fetch(`${apiBaseURL}/${func}`);
            const json = await response.json();
            return json;
        }


        async function loadGraph(name) {
            const response = await fetch(`${apiBaseURL}/loadgraph/${name}`);
            const json = await response.json();
            return json;
        }

        const width = 800;
        const height = 600;


        chainGraph = {
            nodes: [],
            links: [],
        }

        const simulation = d3.forceSimulation()
            .force("charge", d3.forceManyBody().strength(-100))
            .force("center", d3.forceCenter(width / 2, height / 2))
            // .force("links", d3.forceLink(data.links).distance(100))
            .force("collision", d3.forceCollide().radius(50))
            .nodes(chainGraph.nodes)
            .on("tick", () => {
                // links.attr("x1", d => d.source.x)
                //   .attr("y1", d => d.source.y)
                //   .attr("x2", d => d.target.x)
                //   .attr("y2", d => d.target.y);

                svg.selectAll('.node')
                    .attr("cx", function (d) { return d.x })
                    .attr("cy", function (d) { return d.y })
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })
            });

        const svg = d3.select("#force-directed-layout");
        // let node = svg.selectAll("circle");

        const graphBox = d3.select("#hc-graphs");

        function updateForceDirectedLayout(graphData) {

            // const old = new Map(chainGraph.nodes.map(d => [d.name, d]));
            // chainGraph.nodes = chainGraph.nodes.map(d => Object.assign(old.get(d.name) || {}, d));

            // update links
            var link = svg.selectAll('.link').data(chainGraph.links);
            link.enter()
                .insert('line', '.node')
                .attr('class', 'link')
                .style('stroke', '#d9d9d9');
            link
                .exit()
                .remove()

            // update nodes
            var node = svg.selectAll('.node').data(chainGraph.nodes);
            var g = node.enter()
                .append('g')
                .attr('class', 'node');
            g.append('circle')
                .attr("r", 20)
                .style("fill", "#d9d9d9");
            g.append('text')
                .attr("class", "text")
                .text(function (d) { return d.name });
            node
                .exit()
                .remove();

            // update simulation
            simulation
                .nodes(chainGraph.nodes)
                .force("link", d3.forceLink(chainGraph.links).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .restart();

            //   const links = svg.selectAll("line")
            //     .data(data.links)
            //     .enter()
            //     .append("line")
            //     .style("stroke", "#aaa");

            // node = node
            //     .data(nodes, d => d.name)
            //     .join(enter =>
            //         enter.append("circle")
            //             .attr("r", 60)
            //             .attr("fill", d => "cyan")
            //     );
            // enter.append("text")
            //     .text(function (d) {
            //         return d.name;
            //     })
            //     .style('fill', '#000')
            //     .style('font-size', '12px')
            //     .attr('x', 6)
            //     .attr('y', 3);

            // nodes.append("circle")
            //     .attr("r", 20)
            //     .style("fill", "#69b3a2");

            // nodes.append("text")
            //     .text(function (d) {
            //         return d.name;
            //     })
            //     .style('fill', '#000')
            //     .style('font-size', '12px')
            //     .attr('x', 6)
            //     .attr('y', 3);


        }

        function updateGraphDisplay(g) {
            console.log(g);

            graphData = {
                nodes: g.Nodes.map((node, index) => ({ node, index })),
                // links: graphData.nodes.flatMap((node, index) => (
                //   node.outputs.map(output => ({ source: index, target: output }))
                // )),
            };

            console.log(graphData);
            updateForceDirectedLayout(graphData);
        }

        function updateGraph(name) {
            loadGraph(name).then(g => updateGraphDisplay(g));

        };


        function updateGraphList(data) {
            var sorted = data.sort(function (a, b) { return d3.ascending(a.name, b.name); });

            var graph = graphBox
                .selectAll('div')
                .data(sorted, function (d) { return d.name; });

            var enterDiv = graph.enter()
                .append("div")
                .attr("class", "graphdiv")
                // .style("opacity", 0)
                .on("click", function (d, g) { updateGraph(g.name); })
                ;
            enterDiv.append("div")
                .attr("class", "graphname")
                .text(function (d) { return d.name });

            // graph.transition()
            //     .delay(200)
            //     .style("opacity", 1);
            graph.exit()
                // .transition()
                // .duration(200)
                // .style("opacity", 0)
                .remove();
        }

        async function main() {

            const hcGraphs = await fetchNodeData("getgraphs");
            updateGraphList(hcGraphs);

            const hcNodes = await fetchNodeData("nodedata");
            console.log(hcNodes);


        }

        main();
    </script>
</body>

</html>